/*
 * Copyright (C) 2009-2021 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["i2d/mpe/workassign/manages1/ext/utils/Formatter","sap/m/MessageBox","i2d/mpe/workassign/manages1/ext/fragment/ChangePriorityDialog","i2d/mpe/workassign/manages1/ext/fragment/EditTimeForOADialog"],function(F,M,C,E){return sap.ui.controller("i2d.mpe.workassign.manages1.ext.controller.ListReportExtension",{formatter:F,onInitSmartFilterBarExtension:function(e){var s=e.getSource();if(s instanceof sap.ui.comp.smartfilterbar.SmartFilterBar){var c=new Date();s.setFilterData({OpLtstSchedldExecStrtDte:{conditionTypeInfo:{calendarType:"Gregorian",key:"OpLtstSchedldExecStrtDte",operation:"TO",value1:c,name:"sap.ui.comp.config.condition.DateRangeType"}}});}},onSelectionChange:function(e){this.handleMultiSelectionWithAllOption(e);},handleMultiSelectionWithAllOption:function(e){var l=e.getSource();var s=e.getParameter("changedItem").getProperty("key");var S=l.getProperty("selectedKeys");if(s&&(s==="0")&&(e.getParameter("selected"))){l.setSelectedItems(l.getItems());}else if(s&&(s==="0")&&(!e.getParameter("selected"))){l.setSelectedItems([]);}else{if(S.indexOf("0")!==-1){S.splice(S.indexOf("0"),1);l.setSelectedKeys(S);}else{var n=l.getItems().length;var N=S.length;var d=n-N;if(d===1){l.setSelectedItems(l.getItems());}}}},onBeforeRebindTableExtension:function(e){var b=e.getParameter("bindingParams");b.parameters=b.parameters||{};var s=e.getSource();var S=this.byId(s.getSmartFilterId());var c;var n;if(S instanceof sap.ui.comp.smartfilterbar.SmartFilterBar){var o=S.getControlByKey("OpActyNtwkSegmentType");if(o instanceof sap.m.MultiComboBox){c=o.getSelectedKeys();n=c.length;for(var i=0;i<n;i++){switch(c[i]){case"0":break;case"1":b.filters.push(new sap.ui.model.Filter("OpActyNtwkSegmentType","EQ","1"));break;case"2":b.filters.push(new sap.ui.model.Filter("OpActyNtwkSegmentType","EQ","2"));break;case"3":b.filters.push(new sap.ui.model.Filter("OpActyNtwkSegmentType","EQ","3"));break;}}}}},handleMaterialLinkPress:function(e){var t=this;var o=e.getSource().getBindingContext().getObject();sap.ui.define('MaterialController',['sap/i2d/mpe/lib/popovers1/fragments/MaterialController'],function(a){if(!t.oMaterialPop){t.oMaterialPop=new a();}t.oMaterialPop.openMaterialPopOver(e,t,o.Material,o.ProductionPlant);});},handleOrderNumberLinkPress:function(e){var s=e.getSource();var p=s.getBindingContext().sPath;var P=s.getModel().getProperty(p);var m=P.ManufacturingOrder||P.MRPElement;var t=this;sap.ui.define('ProductionOrderController',['sap/i2d/mpe/lib/popovers1/fragments/ProductionOrderController'],function(a){if(!t.oProductionOrderPop){t.oProductionOrderPop=new a();}t.oProductionOrderPop.openProdOrdPopOver(e,t,m);});},handleWorkCenterLinkPress:function(e){var t=this;sap.ui.define('WorkCenterController',['sap/i2d/mpe/lib/popovers1/fragments/WorkCenterController'],function(W){if(!t.oWorkCenterPop){t.oWorkCenterPop=new W();}t.oWorkCenterPop.openWorkCenterPopOver(e,t);});},onEditTargetTime:function(e){E._initAndOpenEditTimeForOADialog(this.getView(),this.extensionAPI.getSelectedContexts());},onUnassignAll:function(e){var a=this.extensionAPI;var o=a.getSelectedContexts();var t=this;var s=true;var g=jQuery.sap.uid();this.getView().getModel().setDeferredGroups([g]);o.forEach(function(O,i,b){var c=O.getObject();t.getView().getModel().callFunction("/C_ProcgExecOpActyInstceTPUnassign",{groupId:g,method:"POST",urlParameters:{"OpActyNtwkInstance":c.OpActyNtwkInstance,"OpActyNtwkElement":c.OpActyNtwkElement},success:function(d,r){},error:function(d){var r=d.responseText;if(r!==undefined){var R;try{R=JSON.parse(r);var m=R.error.message.value;sap.ui.core.BusyIndicator.hide();if(!this._bMessageOpen){this._bMessageOpen=true;sap.m.MessageBox.error(m,{id:"backEndErrorMessageBoxUnassignAll",title:t.getView().getModel("i18n").getResourceBundle().getText("UnassignmentFailedMessage"),actions:[sap.m.MessageBox.Action.CLOSE],onClose:function(){this._bMessageOpen=false;}.bind(this)});}}catch(f){sap.m.MessageToast.show(t.getView().getModel("i18n").getResourceBundle().getText("UnassignmentFailedMessage"));}}s=false;}});});this.getView().getModel().submitChanges({groupId:g,success:function(d){if(s){sap.m.MessageToast.show(t.getView().getModel("i18n").getResourceBundle().getText("UnAssignmentSuccessToast"));}t.getView().getModel().refresh(true);},error:function(b){t.getView().getModel().refresh(true);jQuery.sap.log.error(b.responseText);}});},onEditAssignedOperators:function(e){sap.m.MessageBox.alert(this.getView().getModel("i18n").getResourceBundle().getText("EditAssignedOperatorsButton"));},onAssignOperators:function(e){this._initAssignOperatorDialog().open();},onUnassignOperators:function(e){var a=this.extensionAPI;var o=a.getSelectedContexts();if(o.length===1){this._initUnassignOperatorDialog().open();}else{sap.m.MessageBox.error(this.getView().getModel("i18n").getResourceBundle().getText("UnassignOperatorsButtonErrorMessage"));}},_initAssignOperatorDialog:function(){var t=this;if(!this._oAssignOperatorDialog){this._oAssignOperatorDialog=sap.ui.xmlfragment("i2d.mpe.workassign.manages1.ext.fragment.AssignOperatorDialog",this);this._oAssignOperatorDialog.setModel(this.getView().getModel("i18n"),"i18n");this._oAssignOperatorDialog.attachAfterClose(function(e){if(t._oAssignOperatorDialog){t._oAssignOperatorDialog.getModel().destroy();sap.ui.getCore().byId("assignOperatorDialog").destroy();t._oAssignOperatorDialog=undefined;}});}sap.ui.getCore().byId("idSearchFieldOperatorDialog").setValue("");sap.ui.getCore().byId("changePriorityButton").setEnabled(false);sap.ui.getCore().byId("assignmentsTable").removeSelections(true);var a=this.extensionAPI;var o=a.getSelectedContexts();this.getView().getModel().setUseBatch(true);var u=new sap.ui.model.json.JSONModel({"I_OpActyAllManufacturingUsers":[]});var f=[];var g=jQuery.sap.uid();this.getView().getModel().setDeferredGroups([g]);o.forEach(function(O,i){t._oAssignOperatorDialog.setBusy(true);t.getView().getModel().read(O.sPath,{groupId:g,urlParameters:{"$expand":"to_OpActyAllManufacturingUsers"},success:function(d){u.getProperty("/I_OpActyAllManufacturingUsers").push.apply(u.getProperty("/I_OpActyAllManufacturingUsers"),d.to_OpActyAllManufacturingUsers.results);},error:function(e){jQuery.sap.log.error(e.responseText);}});});this.getView().getModel().submitChanges({groupId:g,success:function(d){var l={};for(var i in u.getData().I_OpActyAllManufacturingUsers){var c=l[u.getData().I_OpActyAllManufacturingUsers[i].UserID];l[u.getData().I_OpActyAllManufacturingUsers[i].UserID]=u.getData().I_OpActyAllManufacturingUsers[i];if(c){if(u.getData().I_OpActyAllManufacturingUsers[i].UserIsQualified===false||c.UserIsQualified===false){l[u.getData().I_OpActyAllManufacturingUsers[i].UserID].UserIsQualified=false;}if(u.getData().I_OpActyAllManufacturingUsers[i].UserIsOpActyMainWrkCtrMfgUser===true||c.UserIsOpActyMainWrkCtrMfgUser===true){l[u.getData().I_OpActyAllManufacturingUsers[i].UserID].UserIsOpActyMainWrkCtrMfgUser=true;}}}u.getData().I_OpActyAllManufacturingUsers=[];for(i in l){u.getData().I_OpActyAllManufacturingUsers.push(l[i]);}t._oAssignOperatorDialog.setModel(u);t._oAssignOperatorDialog.setBusy(false);var A=sap.ui.getCore().byId("assignOperatorDialogTable");var b=A.getBinding("items");f.push(new sap.ui.model.Filter("UserIsOpActyMainWrkCtrMfgUser",sap.ui.model.FilterOperator.EQ,true));b.filter(f,sap.ui.model.FilterType.Application);},error:function(e){t._oAssignOperatorDialog.setBusy(false);jQuery.sap.log.error(e.responseText);}});sap.ui.getCore().byId("infoToolbar").setVisible(true);sap.ui.getCore().byId("assignButton").setEnabled(false);sap.ui.getCore().byId("assignAndEditTimeButton").setEnabled(false);return this._oAssignOperatorDialog;},_initUnassignOperatorDialog:function(){var t=this;if(!this._oUnassignOperatorDialog){this._oUnassignOperatorDialog=sap.ui.xmlfragment("i2d.mpe.workassign.manages1.ext.fragment.UnassignOperatorDialog",this);this._oUnassignOperatorDialog.setModel(this.getView().getModel("i18n"),"i18n");this._oUnassignOperatorDialog.attachAfterClose(function(e){t._oUnassignOperatorDialog.getModel().destroy();sap.ui.getCore().byId("unassignOperatorDialogTable").destroyItems();});}var a=this.extensionAPI;var o=a.getSelectedContexts();this.getView().getModel().setUseBatch(true);var u=new sap.ui.model.json.JSONModel({"I_OpActyUserAssgmt":[]});var g=jQuery.sap.uid();this.getView().getModel().setDeferredGroups([g]);o.forEach(function(O,i){t._oUnassignOperatorDialog.setBusy(true);t.getView().getModel().read(O.sPath,{groupId:g,urlParameters:{"$expand":"to_OpActyUserAssgmt"},success:function(d){u.getProperty("/I_OpActyUserAssgmt").push.apply(u.getProperty("/I_OpActyUserAssgmt"),d.to_OpActyUserAssgmt.results);},error:function(e){jQuery.sap.log.error(e.responseText);}});});this.getView().getModel().submitChanges({groupId:g,success:function(d){var l={};for(var i in u.getData().I_OpActyUserAssgmt){l[u.getData().I_OpActyUserAssgmt[i].UserID]=u.getData().I_OpActyUserAssgmt[i];}u.getData().I_OpActyUserAssgmt=[];for(i in l){u.getData().I_OpActyUserAssgmt.push(l[i]);}t._oUnassignOperatorDialog.setModel(u);t._oUnassignOperatorDialog.setBusy(false);},error:function(e){t._oUnassignOperatorDialog.setBusy(false);jQuery.sap.log.error(e.responseText);}});sap.ui.getCore().byId("unassignButton").setEnabled(false);return this._oUnassignOperatorDialog;},onOperatorDialogSelectionChange:function(e){if(e.getSource().getSelectedItems().length>0){sap.ui.getCore().byId("assignButton").setEnabled(true);sap.ui.getCore().byId("assignAndEditTimeButton").setEnabled(true);}else{sap.ui.getCore().byId("assignButton").setEnabled(false);sap.ui.getCore().byId("assignAndEditTimeButton").setEnabled(false);}},onAssignedOperatorDialogSelectionChange:function(e){if(e.getSource().getSelectedItems().length>0){sap.ui.getCore().byId("unassignButton").setEnabled(true);}else{sap.ui.getCore().byId("unassignButton").setEnabled(false);}},onOperatorDialogItemPress:function(e){var n=sap.ui.getCore().byId("navConAssignOperatorDialog");var d=sap.ui.getCore().byId("detailPageAssignOperatorDialog");var i=e.getParameter("listItem");var I=i.getModel();var s=I.getProperty(i.getBindingContextPath());var m=this.getView().getModel();d.setModel(m);var p=m.createKey("/C_OpActyAllManufacturingUsers",{"OpActyNtwkInstance":s.OpActyNtwkInstance,"OpActyNtwkElement":s.OpActyNtwkElement,"UserID":s.UserID});d.bindElement(p);n.to(d);var b=sap.ui.getCore().byId("backButton");b.setEnabled(true);var a=sap.ui.getCore().byId("assignOperatorDialog");a.setTitle(this.getView().getModel("i18n").getResourceBundle().getText("Operator"));},onNavBackOperatorDialog:function(e){var n=sap.ui.getCore().byId("navConAssignOperatorDialog");n.back();var b=sap.ui.getCore().byId("backButton");b.setEnabled(false);sap.ui.getCore().byId("changePriorityButton").setEnabled(false);sap.ui.getCore().byId("assignmentsTable").removeSelections(true);var a=sap.ui.getCore().byId("assignOperatorDialog");a.setTitle(this.getView().getModel("i18n").getResourceBundle().getText("AssignOperatorsDialogTitle"));},onAssignOperatorDialogAssign:function(e){var a=this.extensionAPI;var o=a.getSelectedContexts();var t=sap.ui.getCore().byId("assignOperatorDialogTable");var s=t.getSelectedContexts();var b=this;var S=true;var g=jQuery.sap.uid();this.getView().getModel().setDeferredGroups([g]);o.forEach(function(O,i,c){var d=O.getObject();s.forEach(function(u,U,f){var h=u.getObject();b.getView().getModel().callFunction("/C_ProcgExecOpActyInstceTPAssignuser",{groupId:g,method:"POST",urlParameters:{"OpActyNtwkInstance":d.OpActyNtwkInstance,"OpActyNtwkElement":d.OpActyNtwkElement,"ExecUser":h.UserID},success:function(D,r){},error:function(j){var r=j.responseText;if(r!==undefined){var R;try{R=JSON.parse(r);var m=R.error.message.value;sap.ui.core.BusyIndicator.hide();if(!this._bMessageOpen){this._bMessageOpen=true;sap.m.MessageBox.error(m,{id:"backEndErrorMessageBoxAssignOperator",title:b.getView().getModel("i18n").getResourceBundle().getText("AssignmentFailedMessage"),actions:[sap.m.MessageBox.Action.CLOSE],onClose:function(){this._bMessageOpen=false;}.bind(this)});}}catch(k){sap.m.MessageToast.show(b.getView().getModel("i18n").getResourceBundle().getText("AssignmentFailedMessage"));}}S=false;}});});});this.getView().getModel().submitChanges({groupId:g,success:function(d){b.getView().getModel().refresh(true);if(b._oAssignOperatorDialog){b._oAssignOperatorDialog.close();}if(S){sap.m.MessageToast.show(b.getView().getModel("i18n").getResourceBundle().getText("AssignmentSuccessToast"));}},error:function(c){jQuery.sap.log.error(c.responseText);}});},onAssignOperatorDialogAssignAndTime:function(e){var t=this;var a=this.extensionAPI;var o=a.getSelectedContexts();var A=function(b){if(t._oAssignOperatorDialog.isOpen()){sap.ui.getCore().byId("assignButton").firePress();var n=sap.ui.getCore().byId("navConAssignOperatorDialog");n.back();t._oAssignOperatorDialog.close();}};E._initAndOpenEditTimeForOADialog(this.getView(),o,A,A);},onAssignOperatorDialogCancel:function(e){var n=sap.ui.getCore().byId("navConAssignOperatorDialog");n.back();this._oAssignOperatorDialog.close();},onAssignedOperatorDialogUnassign:function(e){var a=this.extensionAPI;var o=a.getSelectedContexts();var t=sap.ui.getCore().byId("unassignOperatorDialogTable");var s=t.getSelectedContexts();var b=this;var S=true;var g=jQuery.sap.uid();this.getView().getModel().setDeferredGroups([g]);o.forEach(function(O,i,c){var d=O.getObject();s.forEach(function(u,U,f){var h=u.getObject();b.getView().getModel().callFunction("/C_ProcgExecOpActyInstceTPUnassign_user",{groupId:g,method:"POST",urlParameters:{"OpActyNtwkInstance":d.OpActyNtwkInstance,"OpActyNtwkElement":d.OpActyNtwkElement,"ExecUser":h.UserID},success:function(D,r){},error:function(j){var r=j.responseText;if(r!==undefined){var R;try{R=JSON.parse(r);var m=R.error.message.value;sap.ui.core.BusyIndicator.hide();if(!this._bMessageOpen){this._bMessageOpen=true;sap.m.MessageBox.error(m,{id:"backEndErrorMessageBoxAssignOperator",title:b.getView().getModel("i18n").getResourceBundle().getText("UnassignmentUserFailedMessage"),actions:[sap.m.MessageBox.Action.CLOSE],onClose:function(){this._bMessageOpen=false;}.bind(this)});}}catch(k){sap.m.MessageToast.show(b.getView().getModel("i18n").getResourceBundle().getText("UnassignmentUserFailedMessage"));}}S=false;}});});});this.getView().getModel().submitChanges({groupId:g,success:function(d){b.getView().getModel().refresh(true);if(b._oUnassignOperatorDialog){b._oUnassignOperatorDialog.close();}if(S){sap.m.MessageToast.show(b.getView().getModel("i18n").getResourceBundle().getText("UnassignUserSuccessToast"));}},error:function(c){jQuery.sap.log.error(c.responseText);}});},onUnassignOperatorDialogCancel:function(e){this._oUnassignOperatorDialog.close();},onResetWorkCenterFilters:function(e){var f=[];var l=sap.ui.getCore().byId("assignOperatorDialogTable");var b=l.getBinding("items");f.push(new sap.ui.model.Filter("UserIsOpActyMainWrkCtrMfgUser",sap.ui.model.FilterOperator.EQ,true));f.push(new sap.ui.model.Filter("UserIsOpActyMainWrkCtrMfgUser",sap.ui.model.FilterOperator.EQ,false));var a=new sap.ui.model.Filter(f,false);b.filter(a,sap.ui.model.FilterType.Application);sap.ui.getCore().byId("infoToolbar").setVisible(false);sap.ui.getCore().byId("idSearchFieldOperatorDialog").setValue("");},onUserLinkPress:function(e){var i=e.getSource().getBindingContext();var t=this;var u=new sap.ui.model.json.JSONModel({"I_OpActyUserAssgmt":[]});if(!this._oPopoverUsers){this._oPopoverUsers=sap.ui.xmlfragment("i2d.mpe.workassign.manages1.ext.fragment.UsersPopover",this);this._oPopoverUsers.setModel(this.getView().getModel("i18n"),"i18n");}this._oPopoverUsers.openBy(e.getSource());this.getView().getModel().read(i.getPath(),{urlParameters:{"$expand":"to_OpActyUserAssgmt"},success:function(d){u.getProperty("/I_OpActyUserAssgmt").push.apply(u.getProperty("/I_OpActyUserAssgmt"),d.to_OpActyUserAssgmt.results);t._oPopoverUsers.setModel(u);},error:function(o){jQuery.sap.log.error(o.responseText);}});},onSearchInOperatorDialog:function(e){var i=[];var q=e.getSource().getValue();var l=sap.ui.getCore().byId("assignOperatorDialogTable");var b=l.getBinding("items");if(sap.ui.getCore().byId("infoToolbar").getVisible()===true){i.push(new sap.ui.model.Filter("UserIsOpActyMainWrkCtrMfgUser",sap.ui.model.FilterOperator.EQ,true));}if(q&&q.length>0){var Q=[];Q.push(new sap.ui.model.Filter("UserID",sap.ui.model.FilterOperator.Contains,q));Q.push(new sap.ui.model.Filter("UserDescription",sap.ui.model.FilterOperator.Contains,q));Q.push(new sap.ui.model.Filter("WorkCenter",sap.ui.model.FilterOperator.Contains,q));Q.push(new sap.ui.model.Filter("WorkCenterText",sap.ui.model.FilterOperator.Contains,q));var o=new sap.ui.model.Filter(Q,false);if(sap.ui.getCore().byId("infoToolbar").getVisible()===true){var a=[];a.push(o);a.push(i);var c=new sap.ui.model.Filter(a,true);b.filter(c,sap.ui.model.FilterType.Application);}else{b.filter(o,sap.ui.model.FilterType.Application);}}else{b.filter(i,sap.ui.model.FilterType.Application);}},handlePhoneNumberLinkPress:function(e){sap.m.URLHelper.triggerTel(e.getSource().getProperty("text"));},handleMobilePhoneNumberLinkPress:function(e){sap.m.URLHelper.triggerTel(e.getSource().getProperty("text"));},handleEmailAddressLinkPress:function(e){sap.m.URLHelper.triggerEmail(e.getSource().getProperty("text"));},onUpdateAssignmentsTableFinished:function(e){var c=e.getParameter("total");var a=sap.ui.getCore().byId("assignmentsTableTitle");a.setText(this.getView().getModel("i18n").getResourceBundle().getText("AssignmentsTitle",[c]));},onUpdateActiveQualificationsTableFinished:function(e){var c=e.getParameter("total");var a=sap.ui.getCore().byId("activeQualificationsTableTitle");a.setText(this.getView().getModel("i18n").getResourceBundle().getText("QualificationsTitle",[c]));},onAssignmentsTableSelectionChange:function(e){if(e.getSource().getSelectedItems().length>0){sap.ui.getCore().byId("changePriorityButton").setEnabled(true);}else{sap.ui.getCore().byId("changePriorityButton").setEnabled(false);}},onClickChangePriority:function(e){var a=sap.ui.getCore().byId("assignmentsTable").getSelectedItem().getBindingContext().getObject();C.initAndOpen(this.getView(),a);}});});
